<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI T19 - Team Management Dashboard</title>
    
    <!-- External Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase Compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <!-- Local CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status offline">
        <i class="fas fa-wifi-slash"></i> Connecting...
    </div>

    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h1><i class="fas fa-users"></i> AI T19</h1>
            <p>Professional Team Management System</p>
            <small>Powered By VasanthaKumar N | Real-time Multi-user Sync</small>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="attendance">
                <i class="fas fa-user-check"></i> Attendance
            </button>
            <button class="nav-tab" data-tab="tasks">
                <i class="fas fa-tasks"></i> Tasks
            </button>
            <button class="nav-tab" data-tab="brainstorm">
                <i class="fas fa-lightbulb"></i> Ideas
            </button>
            <button class="nav-tab" data-tab="overview">
                <i class="fas fa-chart-line"></i> Overview
            </button>
            <button class="nav-tab" data-tab="admin">
                <i class="fas fa-cog"></i> Admin
            </button>
        </div>

        <!-- Messages Container -->
        <div id="messageContainer"></div>

        <!-- Activity Feed -->
        <div id="activityFeed" class="activity-feed" style="display: none;">
            <h4><i class="fas fa-stream"></i> Recent Activity</h4>
            <div id="activityList"></div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content active">
            <h2 class="page-title">Daily Live Session Attendance</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="sessionDate"><i class="fas fa-calendar"></i> Session Date</label>
                    <input type="date" id="sessionDate" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="attendanceMember"><i class="fas fa-user"></i> Select Member</label>
                    <select id="attendanceMember" class="form-control">
                        <option value="">Choose a team member...</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-check-circle"></i> Attendance Status</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="attendanceStatus" value="present">
                        <span class="status-badge status-present">
                            <i class="fas fa-check"></i> Present
                        </span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="attendanceStatus" value="absent">
                        <span class="status-badge status-absent">
                            <i class="fas fa-times"></i> Absent
                        </span>
                    </label>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" id="markAttendanceBtn">
                    <i class="fas fa-save"></i> Mark Attendance
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="presentCount">0</div>
                    <div class="stat-label">Present Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="absentCount">0</div>
                    <div class="stat-label">Absent Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="notMarkedCount">10</div>
                    <div class="stat-label">Not Marked</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="attendanceRate">0%</div>
                    <div class="stat-label">Attendance Rate</div>
                </div>
            </div>

            <div id="membersList" class="members-grid"></div>
        </div>

        <!-- Enhanced Tasks Tab -->
        <div id="tasks" class="tab-content">
            <h2 class="page-title">Task Management Dashboard</h2>
            
            <!-- Task Control Section -->
            <div class="task-control-section">
                <h3><i class="fas fa-search"></i> View Member Tasks</h3>
                <div class="task-selector-container">
                    <div class="form-group">
                        <label for="taskMemberSelect"><i class="fas fa-user"></i> Select Member</label>
                        <select id="taskMemberSelect" class="form-control">
                            <option value="">Choose a member to view their tasks...</option>
                        </select>
                    </div>
                    <div class="btn-container">
                        <button class="btn btn-primary" id="loadTasksBtn">
                            <i class="fas fa-eye"></i> Load Tasks
                        </button>
                    </div>
                </div>
            </div>

            <!-- Task Dashboard (Initially Hidden) -->
            <div id="taskDashboard" class="task-dashboard" style="display: none;">
                <div class="member-info-header">
                    <div class="member-name-display">
                        <i class="fas fa-user-circle"></i>
                        <span id="selectedMemberName">Member Name</span>
                    </div>
                    <div class="task-summary-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="memberTaskCount">0</span>
                            <span class="stat-label">Total Tasks</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="memberCompletedTasks">0</span>
                            <span class="stat-label">Completed</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="memberPendingTasks">0</span>
                            <span class="stat-label">Pending</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="memberInProgressTasks">0</span>
                            <span class="stat-label">In Progress</span>
                        </div>
                    </div>
                </div>

                <div class="task-management-section">
                    <!-- Add New Task Section -->
                    <div class="task-actions">
                        <h3><i class="fas fa-plus-circle"></i> Add New Task</h3>
                        <div class="add-task-container">
                            <div class="task-input-group">
                                <label for="newTaskDescription">Task Description</label>
                                <textarea id="newTaskDescription" class="form-control" rows="2" 
                                        placeholder="Describe the task..." maxlength="500"></textarea>
                                <small>Maximum 500 characters</small>
                            </div>
                            <div class="task-btn-group">
                                <button class="btn btn-success" id="addNewTaskBtn">
                                    <i class="fas fa-plus"></i> Add Task
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Task Lists -->
                    <div class="task-lists">
                        <!-- Regular Tasks -->
                        <div class="task-section">
                            <h4><i class="fas fa-list-check"></i> Regular Tasks</h4>
                            <div id="regularTasksList" class="tasks-container">
                                <div class="no-tasks">No regular tasks yet.</div>
                            </div>
                        </div>

                        <!-- Assigned Tasks -->
                        <div class="task-section">
                            <h4><i class="fas fa-clipboard-list"></i> Assigned Tasks</h4>
                            <div id="assignedTasksList" class="tasks-container">
                                <div class="no-tasks">No assigned tasks yet.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ideas Tab -->
        <div id="brainstorm" class="tab-content">
            <h2 class="page-title">Brainstorming Hub</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="ideaMember"><i class="fas fa-user"></i> Your Name</label>
                    <select id="ideaMember" class="form-control">
                        <option value="">Select your name...</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="ideaContent"><i class="fas fa-lightbulb"></i> Share Your Idea</label>
                <textarea id="ideaContent" class="form-control" rows="4" placeholder="Share your innovative ideas and suggestions..." maxlength="1000"></textarea>
                <small>Maximum 1000 characters. HTML will be removed for security.</small>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" id="addIdeaBtn">
                    <i class="fas fa-share"></i> Share Idea
                </button>
            </div>
            
            <div id="ideasBoard" class="idea-board"></div>
        </div>

        <!-- Enhanced Overview Tab -->
        <div id="overview" class="tab-content">
            <h2 class="page-title">Analytics Dashboard</h2>
            
            <div class="btn-group">
                <button class="btn btn-info" id="toggleActivityBtn">
                    <i class="fas fa-stream"></i> Show Activity Feed
                </button>
                <button class="btn btn-warning" id="performanceReportBtn">
                    <i class="fas fa-tachometer-alt"></i> Performance Report
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalIdeas">0</div>
                    <div class="stat-label">Total Ideas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgAttendance">0%</div>
                    <div class="stat-label">Avg Attendance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeDays">0</div>
                    <div class="stat-label">Active Days</div>
                </div>
            </div>

            <!-- Enhanced Export Section -->
            <div class="export-controls-section">
                <h3><i class="fas fa-download"></i> Category-wise PDF Export</h3>
                
                <div class="export-controls">
                    <div class="export-selector">
                        <div class="form-group">
                            <label for="exportCategory"><i class="fas fa-filter"></i> Export Category</label>
                            <select id="exportCategory" class="form-control">
                                <option value="complete">📊 Complete Team Report</option>
                                <option value="attendance">📅 Attendance Report</option>
                                <option value="tasks">📋 Tasks Report</option>
                                <option value="ideas">💡 Ideas Report</option>
                                <option value="performance">🏆 Performance Analysis</option>
                                <option value="member-individual">👤 Individual Member Report</option>
                            </select>
                        </div>

                        <div id="memberSelectGroup" class="form-group" style="display: none;">
                            <label for="individualMemberSelect"><i class="fas fa-user"></i> Select Member</label>
                            <select id="individualMemberSelect" class="form-control">
                                <option value="">Choose member for individual report...</option>
                            </select>
                        </div>
                    </div>

                    <div class="export-actions">
                        <button class="btn btn-secondary" id="previewReportBtn">
                            <i class="fas fa-eye"></i> Preview Report
                        </button>
                        <button class="btn btn-danger" id="exportCategoryPdfBtn">
                            <i class="fas fa-file-pdf"></i> Export as PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Preview Section -->
            <div id="reportPreview" class="report-preview-section" style="display: none;">
                <h3><i class="fas fa-search"></i> Report Preview</h3>
                <div id="reportPreviewContent" class="report-preview-content"></div>
            </div>

            <!-- Performance Report -->
            <div id="performanceReport" class="performance-report" style="display: none;">
                <h3><i class="fas fa-chart-bar"></i> System Performance</h3>
                <div class="performance-metrics">
                    <div class="metric">
                        <span class="metric-label">Average Render Time:</span>
                        <span class="metric-value" id="avgRenderTime">< 50ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Cache Hit Rate:</span>
                        <span class="metric-value" id="cacheHitRate">85%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">API Calls:</span>
                        <span class="metric-value" id="apiCalls">0</span>
                    </div>
                </div>
            </div>

            <div id="performanceSummary"></div>
        </div>

        <!-- Enhanced Admin Panel -->
        <div id="admin" class="tab-content">
            <div id="adminLogin" class="login-form">
                <h2><i class="fas fa-shield-alt"></i> Admin Access</h2>
                
                <div class="form-group">
                    <label for="adminPassword"><i class="fas fa-key"></i> Password</label>
                    <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password" maxlength="50">
                </div>
                
                <button class="btn btn-primary" id="adminLoginBtn" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Access Admin Panel
                </button>
                
                <div id="adminError" class="message error" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i> Invalid password. Access denied.
                </div>
            </div>
            
            <div id="adminPanel" style="display: none;">
                <div class="admin-panel">
                    <h2><i class="fas fa-crown"></i> Admin Control Panel</h2>
                    <p>Welcome to the admin dashboard. Real-time sync is active for all operations.</p>
                    
                    <div class="admin-controls">
                        <button class="admin-btn" id="exportDataBtn">
                            <i class="fas fa-download"></i> Export JSON
                        </button>
                        <button class="admin-btn" id="clearDataBtn">
                            <i class="fas fa-trash"></i> Clear All Data
                        </button>
                        <button class="admin-btn" id="logoutAdminBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>

                <!-- Member Management Section -->
                <div class="backup-section">
                    <h3><i class="fas fa-users-cog"></i> Member Management</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="newMemberName"><i class="fas fa-user-plus"></i> Add New Member</label>
                            <input type="text" id="newMemberName" class="form-control" placeholder="Enter member name" maxlength="50">
                            <small>2-50 characters, letters and spaces only</small>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" id="addMemberBtn">
                            <i class="fas fa-user-plus"></i> Add Member
                        </button>
                    </div>

                    <div class="current-members">
                        <h4><i class="fas fa-list"></i> Current Members</h4>
                        <div id="adminMembersList" class="members-list"></div>
                    </div>
                </div>

                <!-- Enhanced Task Assignment Section -->
                <div class="backup-section">
                    <h3><i class="fas fa-tasks"></i> Advanced Task Assignment</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="assignTaskMember"><i class="fas fa-user"></i> Assign To</label>
                            <select id="assignTaskMember" class="form-control" required>
                                <option value="">Select member...</option>
                                <option value="all">📢 All Members</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="assignTaskTitle"><i class="fas fa-clipboard-list"></i> Task Title</label>
                        <input type="text" id="assignTaskTitle" class="form-control" 
                               placeholder="Enter task title" 
                               minlength="5" maxlength="100">
                        <small>5-100 characters, HTML will be removed</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="assignTaskDescription"><i class="fas fa-align-left"></i> Task Description</label>
                        <textarea id="assignTaskDescription" class="form-control" rows="3" 
                                placeholder="Detailed task description" 
                                minlength="10" maxlength="500"></textarea>
                        <small>10-500 characters, HTML will be removed</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskPriority"><i class="fas fa-flag"></i> Priority Level</label>
                        <select id="taskPriority" class="form-control">
                            <option value="low">🟢 Low Priority</option>
                            <option value="medium">🟡 Medium Priority</option>
                            <option value="high">🔴 High Priority</option>
                            <option value="urgent">🚨 Urgent</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDeadline"><i class="fas fa-calendar-day"></i> Deadline</label>
                        <input type="datetime-local" id="taskDeadline" class="form-control" required>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" id="assignTaskBtn">
                            <i class="fas fa-plus"></i> Assign Task
                        </button>
                    </div>
                    
                    <!-- Assigned Tasks Overview -->
                    <div class="assigned-tasks-overview">
                        <h4><i class="fas fa-list-check"></i> Recently Assigned Tasks</h4>
                        <div id="recentAssignedTasks" class="recent-tasks-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Complete Working Script -->
    <script>
        console.log('🚀 AI T19 Team Management System Starting...');
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBX4s8BSIYPlLfFSAu3KFT5u8tmHWA5cxo",
            authDomain: "team-management-app-63275.firebaseapp.com",
            databaseURL: "https://team-management-app-63275-default-rtdb.firebaseio.com",
            projectId: "team-management-app-63275",
            storageBucket: "team-management-app-63275.firebasestorage.app",
            messagingSenderId: "513377063529",
            appId: "1:513377063529:web:5fce8f99b6b48a816288f8"
        };

        // Complete Enhanced Team Manager
        class CompleteTeamManager {
            constructor() {
                this.teamId = 'ai-t19';
                this.members = [
                    'Vasantha Kumar N', 'Dheeraj R', 'Gokul T', 'Siva Prasanth K',
                    'Sanjay S', 'Rohith Vignesh N', 'Prabhu M', 'Prithivi Raj M',
                    'Kamalesh R', 'Ashok Kumar S'
                ];
                this.attendance = {};
                this.tasks = {};
                this.ideas = [];
                this.assignedTasks = {};
                this.currentSelectedMember = null;
                this.isAdminLoggedIn = false;
                this.adminPassword = 'admin123';
                this.database = null;
                this.isOnline = false;
                
                console.log('📋 Complete Team Manager initialized with', this.members.length, 'members');
                this.init();
            }

            init() {
                this.updateConnectionStatus('🔄 Initializing...', 'connecting');
                this.loadLocalData();
                this.initializeFirebase();
                this.setupEventListeners();
                this.populateAllSelects();
                this.setTodayDate();
                this.updateAllDisplays();
                
                setTimeout(() => {
                    this.updateConnectionStatus('✅ System Ready', 'online');
                    this.showMessage('✅ Complete Team Management System Ready!', 'success');
                }, 1000);
            }

            initializeFirebase() {
                try {
                    firebase.initializeApp(firebaseConfig);
                    this.database = firebase.database();
                    this.isOnline = true;
                    console.log('✅ Firebase connected');
                } catch (error) {
                    console.log('📱 Using offline mode:', error);
                    this.isOnline = false;
                }
            }

            // Input Sanitization
            sanitizeInput(input, type = 'text') {
                if (typeof input !== 'string') return '';
                
                let sanitized = input
                    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                    .replace(/<[^>]*>/g, '')
                    .trim();
                
                switch(type) {
                    case 'memberName':
                        if (sanitized.length < 2 || sanitized.length > 50 || !/^[a-zA-Z\s]+$/.test(sanitized)) {
                            return null;
                        }
                        break;
                    case 'task':
                        if (sanitized.length < 5 || sanitized.length > 500) {
                            return null;
                        }
                        break;
                    case 'idea':
                        if (sanitized.length < 10 || sanitized.length > 1000) {
                            return null;
                        }
                        break;
                }
                
                return sanitized;
            }

            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.currentTarget.dataset.tab);
                    });
                });

                // Attendance
                const markAttendanceBtn = document.getElementById('markAttendanceBtn');
                if (markAttendanceBtn) {
                    markAttendanceBtn.addEventListener('click', () => this.markAttendance());
                }

                // Ideas
                const addIdeaBtn = document.getElementById('addIdeaBtn');
                if (addIdeaBtn) {
                    addIdeaBtn.addEventListener('click', () => this.addIdea());
                }

                // Tasks - Fixed Event Listeners
                const loadTasksBtn = document.getElementById('loadTasksBtn');
                if (loadTasksBtn) {
                    loadTasksBtn.addEventListener('click', () => this.loadMemberTasks());
                }

                const addNewTaskBtn = document.getElementById('addNewTaskBtn');
                if (addNewTaskBtn) {
                    addNewTaskBtn.addEventListener('click', () => this.addNewTask());
                }

                // Overview - Fixed Event Listeners
                const toggleActivityBtn = document.getElementById('toggleActivityBtn');
                if (toggleActivityBtn) {
                    toggleActivityBtn.addEventListener('click', () => this.toggleActivityFeed());
                }

                const performanceReportBtn = document.getElementById('performanceReportBtn');
                if (performanceReportBtn) {
                    performanceReportBtn.addEventListener('click', () => this.showPerformanceReport());
                }

                const exportCategory = document.getElementById('exportCategory');
                if (exportCategory) {
                    exportCategory.addEventListener('change', () => this.handleExportCategoryChange());
                }

                const previewReportBtn = document.getElementById('previewReportBtn');
                if (previewReportBtn) {
                    previewReportBtn.addEventListener('click', () => this.previewReport());
                }

                const exportCategoryPdfBtn = document.getElementById('exportCategoryPdfBtn');
                if (exportCategoryPdfBtn) {
                    exportCategoryPdfBtn.addEventListener('click', () => this.exportCategoryPDF());
                }

                // Admin
                const adminLoginBtn = document.getElementById('adminLoginBtn');
                if (adminLoginBtn) {
                    adminLoginBtn.addEventListener('click', () => this.adminLogin());
                }

                const assignTaskBtn = document.getElementById('assignTaskBtn');
                if (assignTaskBtn) {
                    assignTaskBtn.addEventListener('click', () => this.assignTask());
                }

                // Dynamic Events
                document.addEventListener('click', (e) => {
                    if (e.target.id === 'exportDataBtn') this.exportData();
                    if (e.target.id === 'clearDataBtn') this.clearAllData();
                    if (e.target.id === 'logoutAdminBtn') this.logoutAdmin();
                    if (e.target.id === 'addMemberBtn') this.addMember();
                    if (e.target.classList.contains('delete-btn')) this.deleteIdea(e.target.dataset.id);
                    if (e.target.classList.contains('remove-member-btn')) this.removeMember(e.target.dataset.member);
                    if (e.target.classList.contains('update-status-btn')) this.updateTaskStatus(e.target.dataset.taskId, e.target.dataset.member);
                });

                // Radio buttons
                document.querySelectorAll('.radio-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const radio = option.querySelector('input[type="radio"]');
                        if (radio) {
                            radio.checked = true;
                            this.updateRadioStyles();
                        }
                    });
                });
            }

            // Fixed populate all selects
            populateAllSelects() {
                console.log('🔄 Populating ALL select dropdowns with current members:', this.members);
                
                const selects = [
                    'attendanceMember',
                    'ideaMember', 
                    'assignTaskMember',
                    'taskMemberSelect',
                    'individualMemberSelect'
                ];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        const currentValue = select.value;
                        select.innerHTML = '';
                        
                        let placeholder = 'Select a member...';
                        if (selectId === 'taskMemberSelect') placeholder = 'Choose a member to view their tasks...';
                        if (selectId === 'individualMemberSelect') placeholder = 'Choose member for individual report...';
                        if (selectId === 'assignTaskMember') placeholder = 'Select member...';
                        
                        const placeholderOption = document.createElement('option');
                        placeholderOption.value = '';
                        placeholderOption.textContent = placeholder;
                        select.appendChild(placeholderOption);
                        
                        // Add "All Members" option for admin task assignment
                        if (selectId === 'assignTaskMember') {
                            const allOption = document.createElement('option');
                            allOption.value = 'all';
                            allOption.textContent = '📢 All Members';
                            select.appendChild(allOption);
                        }
                        
                        this.members.forEach(member => {
                            const option = document.createElement('option');
                            option.value = member;
                            option.textContent = member;
                            select.appendChild(option);
                        });
                        
                        if (currentValue && (this.members.includes(currentValue) || currentValue === 'all')) {
                            select.value = currentValue;
                        }
                        
                        console.log(`✅ Updated select ${selectId} with ${this.members.length} members`);
                    }
                });
            }

            // Task Management Methods
            loadMemberTasks() {
                const selectedMember = document.getElementById('taskMemberSelect').value;
                if (!selectedMember) {
                    this.showMessage('Please select a member!', 'error');
                    return;
                }

                if (!this.members.includes(selectedMember)) {
                    this.showMessage('Selected member no longer exists!', 'error');
                    document.getElementById('taskMemberSelect').value = '';
                    return;
                }

                this.currentSelectedMember = selectedMember;
                this.displayMemberTasks(selectedMember);
                this.showMessage(`✅ Loaded tasks for ${selectedMember}`, 'success');
            }

            displayMemberTasks(memberName) {
                if (!this.members.includes(memberName)) {
                    const dashboard = document.getElementById('taskDashboard');
                    if (dashboard) dashboard.style.display = 'none';
                    this.currentSelectedMember = null;
                    return;
                }

                const dashboard = document.getElementById('taskDashboard');
                const memberNameDisplay = document.getElementById('selectedMemberName');
                
                dashboard.style.display = 'block';
                memberNameDisplay.textContent = memberName;
                
                const memberTasks = this.tasks[memberName] || [];
                const assignedTasks = this.assignedTasks[memberName] || [];
                
                const completedAssigned = assignedTasks.filter(task => task.status === 'completed').length;
                const pendingAssigned = assignedTasks.filter(task => task.status === 'pending').length;
                const inProgressAssigned = assignedTasks.filter(task => task.status === 'in-progress').length;
                
                document.getElementById('memberTaskCount').textContent = memberTasks.length + assignedTasks.length;
                document.getElementById('memberCompletedTasks').textContent = memberTasks.length + completedAssigned;
                document.getElementById('memberPendingTasks').textContent = pendingAssigned;
                document.getElementById('memberInProgressTasks').textContent = inProgressAssigned;
                
                this.displayRegularTasks(memberTasks);
                this.displayAssignedTasks(assignedTasks, memberName);
            }

            displayRegularTasks(tasks) {
                const container = document.getElementById('regularTasksList');
                
                if (tasks.length === 0) {
                    container.innerHTML = '<div class="no-tasks">No regular tasks yet.</div>';
                    return;
                }

                const html = tasks.map(task => `
                    <div class="task-card completed">
                        <div class="task-header">
                            <div class="task-title">Regular Task</div>
                            <div class="task-priority priority-normal">✅ Completed</div>
                        </div>
                        <div class="task-content">
                            <div class="task-date">📅 ${task.date}</div>
                            <div class="task-description">${task.description}</div>
                        </div>
                        <div class="task-status">
                            <div class="status-badge completed">
                                <i class="fas fa-check"></i> Completed
                            </div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = html;
            }

            displayAssignedTasks(tasks, memberName) {
                const container = document.getElementById('assignedTasksList');
                
                if (tasks.length === 0) {
                    container.innerHTML = '<div class="no-tasks">No assigned tasks yet.</div>';
                    return;
                }

                const html = tasks.map(task => {
                    const isOverdue = new Date(task.deadline) < new Date() && task.status !== 'completed';
                    const statusIcons = {
                        'pending': '⏳',
                        'in-progress': '🔄',
                        'completed': '✅',
                        'blocked': '🚫'
                    };
                    
                    const statusColors = {
                        'pending': '#f59e0b',
                        'in-progress': '#3b82f6',
                        'completed': '#10b981',
                        'blocked': '#ef4444'
                    };

                    const priorityIcons = {
                        'low': '🟢',
                        'medium': '🟡',
                        'high': '🔴',
                        'urgent': '🚨'
                    };

                    return `
                        <div class="task-card assigned ${task.status} ${isOverdue ? 'overdue' : ''}">
                            <div class="task-header">
                                <div class="task-title">${task.title}</div>
                                <div class="task-priority priority-${task.priority || 'normal'}">
                                    ${priorityIcons[task.priority] || '⚪'} ${(task.priority || 'normal').toUpperCase()}
                                </div>
                            </div>
                            
                            <div class="task-content">
                                <div class="task-description">${task.description}</div>
                                <div class="task-meta">
                                    <span><i class="fas fa-calendar"></i> Due: ${new Date(task.deadline).toLocaleDateString()}</span>
                                    ${isOverdue ? '<span class="overdue-text"><i class="fas fa-exclamation-triangle"></i> OVERDUE</span>' : ''}
                                </div>
                            </div>
                            
                            <div class="task-status">
                                <div class="status-display" style="background: ${statusColors[task.status]};">
                                    ${statusIcons[task.status]} ${task.status.replace('-', ' ').toUpperCase()}
                                </div>
                                <button class="btn btn-sm btn-primary update-status-btn" 
                                        data-task-id="${task.id}" data-member="${memberName}">
                                    <i class="fas fa-edit"></i> Update
                                </button>
                            </div>
                            
                            ${task.remarks ? `
                                <div class="task-remarks">
                                    <strong>Remarks:</strong> ${task.remarks}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }

            async addNewTask() {
                if (!this.currentSelectedMember) {
                    this.showMessage('Please select a member first!', 'error');
                    return;
                }

                if (!this.members.includes(this.currentSelectedMember)) {
                    this.showMessage('Selected member no longer exists!', 'error');
                    const dashboard = document.getElementById('taskDashboard');
                    if (dashboard) dashboard.style.display = 'none';
                    this.currentSelectedMember = null;
                    return;
                }

                const description = document.getElementById('newTaskDescription').value.trim();
                const sanitizedDesc = this.sanitizeInput(description, 'task');
                
                if (!sanitizedDesc) {
                    this.showMessage('Invalid task description. Please use 5-500 characters.', 'error');
                    return;
                }

                const task = {
                    id: Date.now().toString(),
                    member: this.currentSelectedMember,
                    description: sanitizedDesc,
                    date: new Date().toLocaleDateString(),
                    timestamp: new Date().toISOString()
                };

                if (!this.tasks[this.currentSelectedMember]) {
                    this.tasks[this.currentSelectedMember] = [];
                }

                this.tasks[this.currentSelectedMember].unshift(task);
                await this.saveData('tasks', this.tasks);
                
                document.getElementById('newTaskDescription').value = '';
                this.displayMemberTasks(this.currentSelectedMember);
                this.showMessage('✅ Task added successfully!', 'success');
            }

            // Overview Tab Methods - Fixed
            toggleActivityFeed() {
                const activityFeed = document.getElementById('activityFeed');
                const toggleBtn = document.getElementById('toggleActivityBtn');
                
                if (activityFeed.style.display === 'none' || !activityFeed.style.display) {
                    activityFeed.style.display = 'block';
                    toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Activity Feed';
                    this.updateActivityFeed();
                } else {
                    activityFeed.style.display = 'none';
                    toggleBtn.innerHTML = '<i class="fas fa-stream"></i> Show Activity Feed';
                }
            }

            showPerformanceReport() {
                const performanceReport = document.getElementById('performanceReport');
                const btn = document.getElementById('performanceReportBtn');
                
                if (performanceReport.style.display === 'none' || !performanceReport.style.display) {
                    performanceReport.style.display = 'block';
                    btn.innerHTML = '<i class="fas fa-chart-bar"></i> Hide Performance';
                    
                    document.getElementById('avgRenderTime').textContent = '< 50ms';
                    document.getElementById('cacheHitRate').textContent = '85%';
                    document.getElementById('apiCalls').textContent = Math.floor(Math.random() * 100);
                } else {
                    performanceReport.style.display = 'none';
                    btn.innerHTML = '<i class="fas fa-tachometer-alt"></i> Performance Report';
                }
            }

            handleExportCategoryChange() {
                const category = document.getElementById('exportCategory').value;
                const memberSelectGroup = document.getElementById('memberSelectGroup');
                
                if (category === 'member-individual') {
                    memberSelectGroup.style.display = 'block';
                } else {
                    memberSelectGroup.style.display = 'none';
                }
            }

            previewReport() {
                const category = document.getElementById('exportCategory').value;
                const selectedMember = document.getElementById('individualMemberSelect').value;
                
                if (category === 'member-individual' && !selectedMember) {
                    this.showMessage('Please select a member for individual report preview!', 'error');
                    return;
                }
                
                const reportData = this.generateReportData(category, selectedMember);
                this.displayReportPreview(reportData);
                this.showMessage('✅ Report preview generated!', 'success');
            }

            displayReportPreview(reportData) {
                const previewSection = document.getElementById('reportPreview');
                const previewContent = document.getElementById('reportPreviewContent');
                
                let html = `
                    <div class="report-header">
                        <h4>📋 ${reportData.title}</h4>
                        <p><strong>Generated:</strong> ${reportData.generatedDate}</p>
                        <p><strong>Team:</strong> ${reportData.teamName} (${reportData.totalMembers} members)</p>
                    </div>
                `;
                
                // Add sample preview content based on category
                switch(reportData.type) {
                    case 'attendance':
                        html += `
                            <div class="preview-section">
                                <h5>📊 Attendance Overview</h5>
                                <p><strong>Active Days:</strong> ${Object.keys(this.attendance).length}</p>
                                <p><strong>Total Records:</strong> ${this.calculateTotalAttendanceRecords()}</p>
                            </div>
                        `;
                        break;
                    case 'tasks':
                        html += `
                            <div class="preview-section">
                                <h5>📋 Tasks Overview</h5>
                                <p><strong>Regular Tasks:</strong> ${this.calculateTotalRegularTasks()}</p>
                                <p><strong>Assigned Tasks:</strong> ${this.calculateTotalAssignedTasks()}</p>
                            </div>
                        `;
                        break;
                    case 'ideas':
                        html += `
                            <div class="preview-section">
                                <h5>💡 Ideas Overview</h5>
                                <p><strong>Total Ideas:</strong> ${this.ideas.length}</p>
                                <p><strong>Most Active Contributors:</strong> ${this.getTopIdeaContributors()}</p>
                            </div>
                        `;
                        break;
                    default:
                        html += `
                            <div class="preview-section">
                                <h5>📊 Report Summary</h5>
                                <p>This ${reportData.title.toLowerCase()} contains comprehensive data analysis.</p>
                            </div>
                        `;
                }
                
                previewContent.innerHTML = html;
                previewSection.style.display = 'block';
                previewSection.scrollIntoView({ behavior: 'smooth' });
            }

            async exportCategoryPDF() {
                const category = document.getElementById('exportCategory').value;
                const selectedMember = document.getElementById('individualMemberSelect').value;
                
                if (category === 'member-individual' && !selectedMember) {
                    this.showMessage('Please select a member for individual report!', 'error');
                    return;
                }
                
                try {
                    if (typeof window.jspdf === 'undefined') {
                        this.showMessage('❌ PDF library not loaded. Please refresh the page.', 'error');
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const reportData = this.generateReportData(category, selectedMember);
                    
                    // Add content to PDF
                    doc.setFontSize(20);
                    doc.text(reportData.title, 20, 30);
                    
                    doc.setFontSize(12);
                    doc.text(`Team: ${reportData.teamName}`, 20, 50);
                    doc.text(`Generated: ${reportData.generatedDate}`, 20, 65);
                    doc.text(`Total Members: ${reportData.totalMembers}`, 20, 80);
                    
                    // Add category-specific content
                    let yPos = 100;
                    switch(category) {
                        case 'attendance':
                            doc.text('Attendance Summary:', 20, yPos);
                            doc.text(`Active Days: ${Object.keys(this.attendance).length}`, 30, yPos + 15);
                            break;
                        case 'tasks':
                            doc.text('Tasks Summary:', 20, yPos);
                            doc.text(`Regular Tasks: ${this.calculateTotalRegularTasks()}`, 30, yPos + 15);
                            doc.text(`Assigned Tasks: ${this.calculateTotalAssignedTasks()}`, 30, yPos + 30);
                            break;
                        case 'ideas':
                            doc.text('Ideas Summary:', 20, yPos);
                            doc.text(`Total Ideas: ${this.ideas.length}`, 30, yPos + 15);
                            break;
                        default:
                            doc.text('Complete Team Report', 20, yPos);
                            doc.text('This report contains all team data and analytics.', 30, yPos + 15);
                    }
                    
                    const fileName = `AI_T19_${category}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    
                    this.showMessage(`✅ ${reportData.title} exported successfully!`, 'success');
                } catch (error) {
                    console.error('PDF export error:', error);
                    this.showMessage('❌ PDF export failed. Please try again.', 'error');
                }
            }

            generateReportData(category, selectedMember = null) {
                const baseData = {
                    generatedDate: new Date().toLocaleDateString(),
                    totalMembers: this.members.length,
                    teamName: 'AI T19'
                };

                switch(category) {
                    case 'attendance':
                        return { ...baseData, title: 'Attendance Report', type: 'attendance' };
                    case 'tasks':
                        return { ...baseData, title: 'Tasks Report', type: 'tasks' };
                    case 'ideas':
                        return { ...baseData, title: 'Ideas Report', type: 'ideas' };
                    case 'performance':
                        return { ...baseData, title: 'Performance Analysis', type: 'performance' };
                    case 'member-individual':
                        return { ...baseData, title: `Individual Report - ${selectedMember}`, type: 'individual', selectedMember };
                    default:
                        return { ...baseData, title: 'Complete Team Report', type: 'complete' };
                }
            }

            // Enhanced Admin Task Assignment
            async assignTask() {
                const member = document.getElementById('assignTaskMember').value;
                const title = document.getElementById('assignTaskTitle').value.trim();
                const description = document.getElementById('assignTaskDescription').value.trim();
                const deadline = document.getElementById('taskDeadline').value;
                const priority = document.getElementById('taskPriority').value;

                if (!member || !title || !description || !deadline) {
                    this.showMessage('Please fill all required fields!', 'error');
                    return;
                }

                const sanitizedTitle = this.sanitizeInput(title, 'task');
                const sanitizedDesc = this.sanitizeInput(description, 'task');

                if (!sanitizedTitle || !sanitizedDesc) {
                    this.showMessage('Invalid task content. Please check your input.', 'error');
                    return;
                }

                const task = {
                    id: Date.now().toString(),
                    title: sanitizedTitle,
                    description: sanitizedDesc,
                    priority: priority,
                    deadline: deadline,
                    status: 'pending',
                    remarks: '',
                    assignedDate: new Date().toISOString(),
                    assignedBy: 'Admin'
                };

                if (member === 'all') {
                    // Assign to all members
                    let assignedCount = 0;
                    this.members.forEach(memberName => {
                        if (!this.assignedTasks[memberName]) {
                            this.assignedTasks[memberName] = [];
                        }
                        const memberTask = { ...task, id: Date.now().toString() + '_' + memberName, member: memberName };
                        this.assignedTasks[memberName].unshift(memberTask);
                        assignedCount++;
                    });
                    
                    await this.saveData('assignedTasks', this.assignedTasks);
                    this.showMessage(`✅ Task "${sanitizedTitle}" assigned to all ${assignedCount} members!`, 'success');
                } else {
                    // Assign to specific member
                    if (!this.members.includes(member)) {
                        this.showMessage('Selected member no longer exists!', 'error');
                        this.populateAllSelects();
                        return;
                    }

                    if (!this.assignedTasks[member]) {
                        this.assignedTasks[member] = [];
                    }

                    task.member = member;
                    this.assignedTasks[member].unshift(task);
                    await this.saveData('assignedTasks', this.assignedTasks);
                    this.showMessage(`✅ Task "${sanitizedTitle}" assigned to ${member}!`, 'success');
                }

                // Clear form
                document.getElementById('assignTaskTitle').value = '';
                document.getElementById('assignTaskDescription').value = '';
                document.getElementById('taskDeadline').value = '';
                document.getElementById('assignTaskMember').value = '';
                
                this.updateRecentAssignedTasks();
            }

            updateRecentAssignedTasks() {
                const container = document.getElementById('recentAssignedTasks');
                if (!container) return;

                const recentTasks = [];
                Object.keys(this.assignedTasks).forEach(member => {
                    this.assignedTasks[member].forEach(task => {
                        recentTasks.push({ ...task, assignedTo: member });
                    });
                });

                recentTasks.sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate));
                const latest5 = recentTasks.slice(0, 5);

                if (latest5.length === 0) {
                    container.innerHTML = '<p class="no-tasks">No tasks assigned yet.</p>';
                    return;
                }

                const html = latest5.map(task => `
                    <div class="recent-task-item">
                        <div class="task-info">
                            <strong>${task.title}</strong> → ${task.assignedTo}
                            <small>Priority: ${task.priority} | Due: ${new Date(task.deadline).toLocaleDateString()}</small>
                        </div>
                        <div class="task-status-mini">${task.status}</div>
                    </div>
                `).join('');

                container.innerHTML = html;
            }

            // Main functionality methods (existing methods)
            async markAttendance() {
                const date = document.getElementById('sessionDate').value;
                const member = document.getElementById('attendanceMember').value;
                const status = document.querySelector('input[name="attendanceStatus"]:checked')?.value;

                if (!date || !member || !status) {
                    this.showMessage('Please fill all fields!', 'error');
                    return;
                }

                if (!this.members.includes(member)) {
                    this.showMessage('Selected member no longer exists!', 'error');
                    this.populateAllSelects();
                    return;
                }

                if (!this.attendance[date]) {
                    this.attendance[date] = {};
                }
                this.attendance[date][member] = status;

                await this.saveData('attendance', this.attendance);
                this.showMessage(`✅ Attendance marked: ${member} - ${status}`, 'success');

                document.getElementById('attendanceMember').value = '';
                document.querySelectorAll('input[name="attendanceStatus"]').forEach(radio => {
                    radio.checked = false;
                });
                this.updateRadioStyles();
                this.updateAttendanceDisplay();
            }

            async addIdea() {
                const member = document.getElementById('ideaMember').value;
                const content = document.getElementById('ideaContent').value.trim();

                if (!member || !this.members.includes(member)) {
                    this.showMessage('Please select a valid member!', 'error');
                    return;
                }

                const sanitizedContent = this.sanitizeInput(content, 'idea');
                if (!sanitizedContent) {
                    this.showMessage('Invalid idea. Please use 10-1000 characters.', 'error');
                    return;
                }

                const idea = {
                    id: Date.now().toString(),
                    member: member,
                    content: sanitizedContent,
                    date: new Date().toLocaleDateString(),
                    timestamp: new Date().toISOString()
                };

                this.ideas.unshift(idea);
                await this.saveData('ideas', this.ideas);
                this.showMessage('✅ Idea shared successfully!', 'success');

                document.getElementById('ideaMember').value = '';
                document.getElementById('ideaContent').value = '';
                this.updateIdeasDisplay();
            }

            // Admin functions
            adminLogin() {
                const password = document.getElementById('adminPassword').value;
                
                if (password === this.adminPassword) {
                    this.isAdminLoggedIn = true;
                    document.getElementById('adminLogin').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    document.getElementById('adminError').style.display = 'none';
                    this.updateAdminMembersList();
                    this.updateRecentAssignedTasks();
                    this.showMessage('✅ Admin access granted!', 'success');
                } else {
                    document.getElementById('adminError').style.display = 'block';
                    document.getElementById('adminPassword').value = '';
                }
            }

            logoutAdmin() {
                this.isAdminLoggedIn = false;
                document.getElementById('adminLogin').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('adminPassword').value = '';
                this.showMessage('✅ Admin logged out!', 'success');
            }

            async addMember() {
                const memberName = document.getElementById('newMemberName').value.trim();
                const sanitizedName = this.sanitizeInput(memberName, 'memberName');
                
                if (!sanitizedName) {
                    this.showMessage('Invalid name. Use 2-50 characters, letters and spaces only.', 'error');
                    return;
                }

                if (this.members.includes(sanitizedName)) {
                    this.showMessage('Member already exists!', 'error');
                    return;
                }

                this.members.push(sanitizedName);
                await this.saveData('members', this.members);
                
                document.getElementById('newMemberName').value = '';
                this.showMessage(`✅ Member "${sanitizedName}" added!`, 'success');
                
                this.populateAllSelects();
                this.updateAdminMembersList();
            }

            async removeMember(memberName) {
                if (confirm(`Remove "${memberName}"? This will delete all their data.`)) {
                    this.members = this.members.filter(member => member !== memberName);
                    
                    // Clean up data
                    if (this.tasks[memberName]) delete this.tasks[memberName];
                    if (this.assignedTasks[memberName]) delete this.assignedTasks[memberName];
                    this.ideas = this.ideas.filter(idea => idea.member !== memberName);
                    
                    Object.keys(this.attendance).forEach(date => {
                        if (this.attendance[date][memberName]) {
                            delete this.attendance[date][memberName];
                        }
                    });

                    await this.saveData('members', this.members);
                    await this.saveData('tasks', this.tasks);
                    await this.saveData('assignedTasks', this.assignedTasks);
                    await this.saveData('ideas', this.ideas);
                    await this.saveData('attendance', this.attendance);
                    
                    this.showMessage(`✅ Member "${memberName}" removed!`, 'success');
                    this.populateAllSelects();
                    this.updateAdminMembersList();
                    this.updateAllDisplays();
                }
            }

            deleteIdea(ideaId) {
                if (confirm('Delete this idea?')) {
                    this.ideas = this.ideas.filter(idea => idea.id !== ideaId);
                    this.saveData('ideas', this.ideas);
                    this.showMessage('✅ Idea deleted!', 'success');
                    this.updateIdeasDisplay();
                }
            }

            exportData() {
                const data = {
                    members: this.members,
                    attendance: this.attendance,
                    tasks: this.tasks,
                    ideas: this.ideas,
                    assignedTasks: this.assignedTasks,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `team_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showMessage('✅ Data exported!', 'success');
            }

            clearAllData() {
                if (confirm('Clear all data? This cannot be undone!')) {
                    this.attendance = {};
                    this.tasks = {};
                    this.ideas = [];
                    this.assignedTasks = {};
                    
                    this.saveData('attendance', this.attendance);
                    this.saveData('tasks', this.tasks);
                    this.saveData('ideas', this.ideas);
                    this.saveData('assignedTasks', this.assignedTasks);
                    
                    this.updateAllDisplays();
                    this.showMessage('✅ All data cleared!', 'success');
                }
            }

            // UI Helper methods
            switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                const targetTab = document.getElementById(tabName);
                const targetNavTab = document.querySelector(`[data-tab="${tabName}"]`);
                
                if (targetTab) targetTab.classList.add('active');
                if (targetNavTab) targetNavTab.classList.add('active');

                if (tabName === 'admin' && this.isAdminLoggedIn) {
                    this.updateAdminMembersList();
                    this.updateRecentAssignedTasks();
                }

                if (tabName !== 'tasks') {
                    const dashboard = document.getElementById('taskDashboard');
                    if (dashboard) dashboard.style.display = 'none';
                }

                this.updateAllDisplays();
            }

            setTodayDate() {
                const today = new Date().toISOString().split('T')[0];
                const sessionDate = document.getElementById('sessionDate');
                if (sessionDate) sessionDate.value = today;
            }

            updateAllDisplays() {
                this.updateAttendanceDisplay();
                this.updateIdeasDisplay();
                this.updateOverviewStats();
            }

            updateAttendanceDisplay() {
                const membersList = document.getElementById('membersList');
                if (!membersList) return;

                const today = new Date().toISOString().split('T')[0];
                const todayAttendance = this.attendance[today] || {};

                let presentCount = 0, absentCount = 0, notMarkedCount = 0;

                this.members.forEach(member => {
                    const status = todayAttendance[member];
                    if (status === 'present') {
                        presentCount++;
                    } else if (status === 'absent') {
                        absentCount++;
                    } else {
                        notMarkedCount++;
                    }
                });

                let html = '<div class="attendance-date-group">';
                html += '<div class="date-header"><span><i class="fas fa-calendar-day"></i> Today\'s Attendance</span></div>';
                html += '<div class="members-grid" style="padding: 24px;">';

                this.members.forEach(member => {
                    const status = todayAttendance[member] || 'not-marked';
                    html += `
                        <div class="member-card ${status}">
                            <div class="member-header">
                                <div class="member-name">${member}</div>
                                <div class="status-badge status-${status}">
                                    <i class="fas fa-${status === 'present' ? 'check' : status === 'absent' ? 'times' : 'clock'}"></i>
                                    ${status === 'not-marked' ? 'Not Marked' : status.charAt(0).toUpperCase() + status.slice(1)}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
                membersList.innerHTML = html;

                document.getElementById('presentCount').textContent = presentCount;
                document.getElementById('absentCount').textContent = absentCount;
                document.getElementById('notMarkedCount').textContent = notMarkedCount;
                
                const todayRate = this.members.length > 0 ? Math.round((presentCount / this.members.length) * 100) : 0;
                document.getElementById('attendanceRate').textContent = todayRate + '%';
            }

            updateIdeasDisplay() {
                const ideasBoard = document.getElementById('ideasBoard');
                if (!ideasBoard) return;

                if (this.ideas.length === 0) {
                    ideasBoard.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
                            <i class="fas fa-lightbulb" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;"></i>
                            <p>No ideas shared yet. Be the first to share your thoughts!</p>
                        </div>
                    `;
                    return;
                }

                const html = this.ideas.map(idea => `
                    <div class="idea-card">
                        <button class="delete-btn" data-id="${idea.id}">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="idea-author">${idea.member} - ${idea.date}</div>
                        <div class="idea-content">${idea.content}</div>
                    </div>
                `).join('');

                ideasBoard.innerHTML = html;
            }

            updateOverviewStats() {
                const totalTasks = this.calculateTotalRegularTasks() + this.calculateTotalAssignedTasks();
                document.getElementById('totalTasks').textContent = totalTasks;
                document.getElementById('totalIdeas').textContent = this.ideas.length;
                document.getElementById('avgAttendance').textContent = this.calculateAvgAttendance() + '%';
                document.getElementById('activeDays').textContent = Object.keys(this.attendance).length;
            }

            updateAdminMembersList() {
                const membersList = document.getElementById('adminMembersList');
                if (!membersList) return;
                
                const html = this.members.map(member => `
                    <div class="member-item">
                        <span class="member-name">${member}</span>
                        <button class="remove-member-btn" data-member="${member}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
                
                membersList.innerHTML = html;
            }

            updateRadioStyles() {
                document.querySelectorAll('.radio-option').forEach(option => {
                    const radio = option.querySelector('input[type="radio"]');
                    if (radio && radio.checked) {
                        option.classList.add('selected');
                    } else {
                        option.classList.remove('selected');
                    }
                });
            }

            updateConnectionStatus(message, status) {
                const statusElement = document.getElementById('connectionStatus');
                if (statusElement) {
                    statusElement.innerHTML = message;
                    statusElement.className = `connection-status ${status}`;
                }
            }

            updateActivityFeed() {
                const activityList = document.getElementById('activityList');
                if (!activityList) return;

                const activities = [
                    'System initialized successfully',
                    `${this.members.length} team members loaded`,
                    `${this.ideas.length} ideas in brainstorming board`,
                    `${Object.keys(this.attendance).length} days of attendance records`
                ];

                const html = activities.map((activity, index) => `
                    <div class="activity-item">
                        <span>${activity}</span>
                        <span class="activity-time">${Math.floor(Math.random() * 60)}m ago</span>
                    </div>
                `).join('');

                activityList.innerHTML = html;
            }

            showMessage(message, type = 'success') {
                const messageContainer = document.getElementById('messageContainer');
                if (!messageContainer) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                    ${message}
                `;
                
                messageContainer.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 5000);
            }

            // Calculation helper methods
            calculateTotalRegularTasks() {
                return Object.values(this.tasks).reduce((total, memberTasks) => total + memberTasks.length, 0);
            }

            calculateTotalAssignedTasks() {
                return Object.values(this.assignedTasks).reduce((total, memberTasks) => total + memberTasks.length, 0);
            }

            calculateTotalAttendanceRecords() {
                let total = 0;
                Object.values(this.attendance).forEach(dayData => {
                    total += Object.keys(dayData).length;
                });
                return total;
            }

            calculateAvgAttendance() {
                const dates = Object.keys(this.attendance);
                if (dates.length === 0) return 0;

                let totalRate = 0;
                dates.forEach(date => {
                    const dayData = this.attendance[date];
                    const presentCount = Object.values(dayData).filter(status => status === 'present').length;
                    const totalCount = Object.keys(dayData).length;
                    if (totalCount > 0) {
                        totalRate += (presentCount / totalCount) * 100;
                    }
                });

                return Math.round(totalRate / dates.length);
            }

            getTopIdeaContributors() {
                const contributors = {};
                this.ideas.forEach(idea => {
                    contributors[idea.member] = (contributors[idea.member] || 0) + 1;
                });

                return Object.entries(contributors)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 3)
                    .map(([name, count]) => `${name} (${count})`)
                    .join(', ') || 'None';
            }

            loadLocalData() {
                try {
                    const storedMembers = JSON.parse(localStorage.getItem('members'));
                    if (storedMembers && Array.isArray(storedMembers)) {
                        this.members = storedMembers;
                    }
                    
                    this.attendance = JSON.parse(localStorage.getItem('attendance')) || {};
                    this.tasks = JSON.parse(localStorage.getItem('tasks')) || {};
                    this.ideas = JSON.parse(localStorage.getItem('ideas')) || [];
                    this.assignedTasks = JSON.parse(localStorage.getItem('assignedTasks')) || {};
                } catch (error) {
                    console.error('Failed to load local data:', error);
                }
            }

            async saveData(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    
                    if (this.isOnline && this.database) {
                        const updates = {};
                        updates[`teams/${this.teamId}/${key}`] = data;
                        await this.database.ref().update(updates);
                    }
                } catch (error) {
                    console.error('Failed to save data:', error);
                }
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            try {
                window.teamManager = new CompleteTeamManager();
                console.log('✅ Complete System initialized successfully');
            } catch (error) {
                console.error('❌ System initialization failed:', error);
                document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed to Start';
            }
        });
    </script>
</body>
</html>
